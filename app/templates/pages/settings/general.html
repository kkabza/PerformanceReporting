{% extends "layouts/authenticated.html" %}

{% block title %}General Settings - Performance Portal{% endblock %}

{% block page_content %}
<div class="min-h-screen bg-gray-100">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        General Settings
                    </h2>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active" 
                        onclick="switchTab('devops')" 
                        data-tab="devops">
                    <i class="fas fa-code-branch mr-2"></i>
                    DevOps
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('app-insights')" 
                        data-tab="app-insights">
                    <i class="fas fa-chart-line mr-2"></i>
                    App Insights
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('grafana')" 
                        data-tab="grafana">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Grafana API
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('azure-openai')" 
                        data-tab="azure-openai">
                    <i class="fas fa-brain mr-2"></i>
                    Azure OpenAI
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="bg-white shadow rounded-lg mt-6">
            <!-- DevOps Settings -->
            <div id="devops" class="tab-content active">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure DevOps Configuration</h3>
                    <form class="space-y-6" id="devopsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization URL</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-200 text-gray-500 text-sm">
                                    https://dev.azure.com/
                                </span>
                                <input type="text" 
                                       id="devops_org_url"
                                       name="devops_org_url"
                                       class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200" 
                                       placeholder="organization"
                                       value="{{ devops_org_url|default('supercomputing2020') }}">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Your Azure DevOps organization name</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token (PAT)</label>
                            <input type="password" 
                                   id="devops_pat"
                                   name="devops_pat"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="Enter your PAT"
                                   value="{{ devops_pat_masked|default('') }}">
                            <p class="mt-1 text-sm text-gray-500">PAT with Read access to Work Items</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testDevOpsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- DevOps Connection Results -->
                        <div id="devopsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="devopsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- App Insights Settings -->
            <div id="app-insights" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">App Insights Configuration</h3>
                    
                    <!-- App Insights Inner Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-4" aria-label="App Insights Tabs">
                            <button class="appinsights-tab-button whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" 
                                    onclick="switchAppInsightsTab('appinsights-connection')" 
                                    data-appinsights-tab="appinsights-connection">
                                <i class="fas fa-plug mr-2"></i>
                                Connection
                            </button>
                            <button class="appinsights-tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                                    onclick="switchAppInsightsTab('appinsights-query')" 
                                    data-appinsights-tab="appinsights-query">
                                <i class="fas fa-database mr-2"></i>
                                Query Editor
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Connection Tab Content -->
                    <div id="appinsights-connection" class="appinsights-tab-content">
                        <form class="space-y-6" id="appInsightsForm">
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            Application Insights is configured using environment variables. The current configuration is shown below.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Application ID</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" 
                                            id="app_id_display"
                                            class="flex-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:border-gray-300 focus:ring-0 cursor-not-allowed"
                                            value="{{ app_insights_id|default('Not configured') }}" 
                                            disabled>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">Set in .env file as APP_INSIGHTS_APPLICATION_ID</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="password" 
                                            id="api_key_display"
                                            class="flex-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:border-gray-300 focus:ring-0 cursor-not-allowed"
                                            value="{{ app_insights_key_masked|default('••••••••') }}" 
                                            disabled>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">Set in .env file as APP_INSIGHTS_API_KEY</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button type="button"
                                        id="testAppInsightsBtn"
                                        onclick="testAppInsightsConnection()"
                                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-plug mr-2"></i>
                                    Test Connection
                                </button>
                            </div>
                            <!-- App Insights Connection Results -->
                            <div id="appInsightsResults" class="mt-4 hidden">
                                <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                                <!-- Loading Spinner -->
                                <div id="appInsightsLoading" class="flex justify-center my-8 hidden">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                                </div>
                                <div id="appInsightsResultContainer" class="bg-gray-100 rounded-md p-4">
                                    <div id="appInsightsResultsContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Query Tab Content -->
                    <div id="appinsights-query" class="appinsights-tab-content hidden">
                        <form class="space-y-6" id="appInsightsQueryForm">
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            Run Kusto queries against your Application Insights instance.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kusto Query</label>
                                <textarea
                                    id="kusto_query"
                                    name="kusto_query"
                                    rows="6"
                                    class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200 font-mono text-sm"
                                    placeholder="// Enter your Kusto query here
traces 
| where timestamp > ago(1h)
| order by timestamp desc 
| take 10"
                                ></textarea>
                                <p class="mt-1 text-sm text-gray-500">Enter a Kusto query to run against Application Insights</p>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                                    <select
                                        id="time_range"
                                        name="time_range"
                                        class="block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200">
                                        <option value="30m">Last 30 minutes</option>
                                        <option value="1h" selected>Last 1 hour</option>
                                        <option value="12h">Last 12 hours</option>
                                        <option value="24h">Last 24 hours</option>
                                        <option value="7d">Last 7 days</option>
                                        <option value="30d">Last 30 days</option>
                                    </select>
                                </div>
                                <div class="flex justify-end">
                                    <button type="button"
                                            id="runKustoQueryBtn"
                                            onclick="runKustoQuery()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i class="fas fa-play mr-2"></i>
                                        Run Query
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Kusto Query Results -->
                            <div id="kustoResults" class="mt-4 hidden">
                                <h4 class="text-md font-medium text-gray-800 mb-2">Query Results</h4>
                                <!-- Loading Spinner -->
                                <div id="kustoLoading" class="flex justify-center my-8 hidden">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                                </div>
                                <div id="kustoResultContainer" class="bg-gray-100 rounded-md p-4">
                                    <div id="kustoResultsContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Grafana API Settings -->
            <div id="grafana" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Grafana API Configuration</h3>
                    <form class="space-y-8" id="grafanaForm">
                        <!-- Connection Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Connection Settings</h4>
                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Grafana URL</label>
                                    <div class="flex rounded-md shadow-sm">
                                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                            https://
                                        </span>
                                        <input type="text" 
                                           name="grafana_url"
                                           id="grafana_url"
                                           class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                           placeholder="your-grafana-instance.com"
                                           value="{{ grafana_url|default('') }}">
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">Your Grafana instance URL</p>
                                    <div class="mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Common Grafana URLs</label>
                                        <select 
                                            id="common_grafana_urls" 
                                            class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            onchange="selectGrafanaUrl(this.value)">
                                            <option value="">Select a common URL</option>
                                            <option value="10.0.10.16:3000">10.0.10.16:3000 (Dev)</option>
                                            <option value="localhost:3000">localhost:3000</option>
                                            <option value="localhost:8080">localhost:8080</option>
                                            <option value="grafana.local">grafana.local</option>
                                            <option value="127.0.0.1:3000">127.0.0.1:3000</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <div class="relative" id="api_key_container">
                                        <input type="password" 
                                               name="api_key"
                                               id="api_key"
                                               class="mt-1 block w-full pr-16 rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                               value="{{ grafana_api_key|default('') }}">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 mt-1">
                                            <button type="button" onclick="toggleApiKeyVisibility()" class="text-gray-400 hover:text-gray-600">
                                                <i id="eye-icon" class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <p class="text-sm text-gray-500">API key with Viewer permissions</p>
                                        <div>
                                            <button type="button" onclick="copyApiKey()" class="text-sm text-blue-600 hover:text-blue-800 mr-2">
                                                <i class="fas fa-copy mr-1"></i> Copy
                                            </button>
                                            <button type="button" onclick="loadApiKeyFromEnv()" class="text-sm text-green-600 hover:text-green-800">
                                                <i class="fas fa-sync-alt mr-1"></i> Load from .env
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Test Query -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Test Query</h4>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Query</label>
                                    <textarea
                                        name="test_query"
                                        id="test_query"
                                        rows="3"
                                        class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                        placeholder="Examples:
up                                      # Shows up/down status of targets
label_values(__name__)                  # Lists all available metrics
rate(node_cpu_seconds_total{mode='idle'}[5m])   # CPU utilization">up</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Enter a simple Prometheus query (e.g., 'up' to see monitoring targets)</p>
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button type="button"
                                            id="testGrafanaBtn"
                                            onclick="testGrafanaConnection()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-plug mr-2"></i>
                                        Test Connection
                                    </button>
                                    <button type="button"
                                            id="testGrafanaQueryBtn"
                                            onclick="testGrafanaQuery()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i class="fas fa-play mr-2"></i>
                                        Run Query
                                    </button>
                                </div>
                            </div>
                            <!-- Query Results -->
                            <div id="grafanaResults" class="mt-4 hidden">
                                <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                                <!-- Loading Spinner -->
                                <div id="grafanaLoading" class="flex justify-center my-8 hidden">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                                </div>
                                <div id="grafanaResultContainer" class="bg-gray-100 rounded-md p-4">
                                    <div id="grafanaResultsContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Azure OpenAI Settings -->
            <div id="azure-openai" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">OpenAI Configuration</h3>
                    <form class="space-y-6" id="openaiForm">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Endpoint</label>
                                <input type="text" 
                                       id="openai_endpoint"
                                       name="openai_endpoint"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="https://your-resource.openai.azure.com/"
                                       value="{{ openai_endpoint }}">
                                <p class="mt-1 text-sm text-gray-500">Your OpenAI service endpoint URL (default: OpenAI API)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <input type="password" 
                                       id="openai_api_key"
                                       name="openai_api_key"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="Using API key from .env file" 
                                       value="{{ openai_api_key_masked }}">
                                <p class="mt-1 text-sm text-gray-500">Your OpenAI API key (loaded from OPENAI_API_KEY in .env)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Model / Deployment Name</label>
                                <select
                                       id="openai_deployment"
                                       name="openai_deployment"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200">
                                    <option value="gpt-3.5-turbo" {% if openai_deployment == 'gpt-3.5-turbo' %}selected{% endif %}>gpt-3.5-turbo</option>
                                    <option value="gpt-3.5-turbo-16k" {% if openai_deployment == 'gpt-3.5-turbo-16k' %}selected{% endif %}>gpt-3.5-turbo-16k</option>
                                    <option value="gpt-4" {% if openai_deployment == 'gpt-4' %}selected{% endif %}>gpt-4</option>
                                    <option value="gpt-4-turbo" {% if openai_deployment == 'gpt-4-turbo' %}selected{% endif %}>gpt-4-turbo</option>
                                    <option value="gpt-4-32k" {% if openai_deployment == 'gpt-4-32k' %}selected{% endif %}>gpt-4-32k</option>
                                    <option value="text-embedding-ada-002" {% if openai_deployment == 'text-embedding-ada-002' %}selected{% endif %}>text-embedding-ada-002</option>
                                    <option value="custom" {% if openai_deployment not in ['gpt-3.5-turbo', 'gpt-3.5-turbo-16k', 'gpt-4', 'gpt-4-turbo', 'gpt-4-32k', 'text-embedding-ada-002'] %}selected{% endif %}>Custom deployment name...</option>
                                </select>
                                <div id="custom_deployment_container" class="mt-2 {% if openai_deployment in ['gpt-3.5-turbo', 'gpt-3.5-turbo-16k', 'gpt-4', 'gpt-4-turbo', 'gpt-4-32k', 'text-embedding-ada-002'] %}hidden{% endif %}">
                                    <input type="text" 
                                           id="custom_deployment"
                                           name="custom_deployment"
                                           class="block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                           placeholder="Enter custom deployment name"
                                           value="{% if openai_deployment not in ['gpt-3.5-turbo', 'gpt-3.5-turbo-16k', 'gpt-4', 'gpt-4-turbo', 'gpt-4-32k', 'text-embedding-ada-002'] %}{{ openai_deployment }}{% endif %}">
                                </div>
                                <p class="mt-1 text-sm text-gray-500">The model or deployment name to use</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testOpenAIConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- OpenAI Connection Results -->
                        <div id="openaiResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <!-- Loading Spinner -->
                            <div id="openaiLoading" class="flex justify-center my-8 hidden">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                            </div>
                            <div id="openaiResultContainer" class="bg-gray-100 rounded-md p-4">
                                <pre id="openaiResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Save Button -->
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg">
                <div class="flex justify-end">
                    <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Notifications Container -->
    <div id="notifications-container" class="fixed bottom-5 right-5 z-50 w-80">
    </div>
</div>

<script>
// Add this notification function at the beginning of the script
function showNotification(message, type = 'info') {
    const container = document.getElementById('notifications-container');
    const id = 'notification-' + Date.now();
    
    let bgColor, textColor, borderColor, icon;
    
    switch(type) {
        case 'success':
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            borderColor = 'border-green-500';
            icon = `<svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>`;
            break;
        case 'error':
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            borderColor = 'border-red-500';
            icon = `<svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>`;
            break;
        case 'warning':
            bgColor = 'bg-yellow-50';
            textColor = 'text-yellow-800';
            borderColor = 'border-yellow-500';
            icon = `<svg class="h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>`;
            break;
        default: // info
            bgColor = 'bg-blue-50';
            textColor = 'text-blue-800';
            borderColor = 'border-blue-500';
            icon = `<svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>`;
    }
    
    const notification = document.createElement('div');
    notification.id = id;
    notification.className = `${bgColor} border-l-4 ${borderColor} p-4 mb-3 shadow-md rounded transform transition-all duration-500 ease-in-out opacity-0 translate-x-10`;
    notification.innerHTML = `
        <div class="flex">
            <div class="flex-shrink-0">
                ${icon}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium ${textColor}">${message}</p>
            </div>
            <div class="ml-auto pl-3">
                <div class="-mx-1.5 -my-1.5">
                    <button onclick="dismissNotification('${id}')" class="${textColor} rounded-md inline-flex p-1.5 hover:${bgColor} focus:outline-none">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(notification);
    
    // Start fade in
    setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-10');
    }, 10);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        dismissNotification(id);
    }, 5000);
    
    return id;
}

function dismissNotification(id) {
    const notification = document.getElementById(id);
    if (notification) {
        notification.classList.add('opacity-0', 'translate-x-10');
        setTimeout(() => {
            notification.remove();
        }, 500);
    }
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.remove('hidden');
    
    // Add active class to selected button
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    activeButton.classList.add('border-blue-500', 'text-blue-600');
}

function switchAppInsightsTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.appinsights-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.appinsights-tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.remove('hidden');
    
    // Add active class to selected button
    const activeButton = document.querySelector(`[data-appinsights-tab="${tabId}"]`);
    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    activeButton.classList.add('border-blue-500', 'text-blue-600');
}

async function testDevOpsConnection() {
    const orgName = document.getElementById('devops_org_url').value;
    const pat = document.getElementById('devops_pat').value;
    
    if (!orgName || !pat) {
        showNotification('Please enter both Organization name and PAT', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/settings/devops/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                organization: orgName,
                pat: pat
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Azure DevOps organization is accessible.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

async function testAppInsightsConnection() {
    try {
        // Show loading spinner
        document.getElementById('appInsightsResults').classList.remove('hidden');
        document.getElementById('appInsightsLoading').classList.remove('hidden');
        document.getElementById('appInsightsResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.getElementById('testAppInsightsBtn');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        const response = await fetch('/settings/api/appinsights/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})  // Using environment variables from backend
        });

        const data = await response.json();
        
        // Hide loading spinner
        document.getElementById('appInsightsLoading').classList.add('hidden');
        document.getElementById('appInsightsResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('appInsightsResultsContent');
        
        if (data.success) {
            // Format Azure Portal style result
            let resultHTML = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-800">Connection successful! Application Insights is properly configured.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Query Details</h5>
                    <div class="bg-gray-200 p-2 rounded">
                        <code class="text-xs font-mono">${data.query}</code>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Results Summary</h5>
                    <div class="flex items-center text-sm">
                        <svg class="mr-2 h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span class="font-medium">${data.rows_count}</span> records found
                    </div>
                </div>`;
                
            if (data.sample_data && data.sample_data.length > 0) {
                resultHTML += `
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Sample Data</h5>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 border border-gray-300 rounded">
                                <thead class="bg-gray-200">
                                    <tr>`;
                
                // Create table headers from the first row's keys
                const headerKeys = Object.keys(data.sample_data[0]);
                headerKeys.forEach(key => {
                    resultHTML += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">${key}</th>`;
                });
                
                resultHTML += `
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-300">`;
                
                // Create table rows
                data.sample_data.forEach(row => {
                    resultHTML += `<tr class="hover:bg-gray-50">`;
                    headerKeys.forEach(key => {
                        // Format timestamp if the value looks like a timestamp
                        let cellValue = row[key];
                        if (key.toLowerCase().includes('time') && typeof cellValue === 'string' && cellValue.includes('T')) {
                            try {
                                const date = new Date(cellValue);
                                cellValue = date.toLocaleString();
                            } catch (e) {
                                // Keep original if parsing fails
                            }
                        }
                        
                        // Truncate long cell values with tooltip
                        if (typeof cellValue === 'string' && cellValue.length > 50) {
                            resultHTML += `<td class="px-3 py-2 text-xs" title="${cellValue}">${cellValue.substring(0, 50)}...</td>`;
                        } else {
                            resultHTML += `<td class="px-3 py-2 text-xs">${cellValue}</td>`;
                        }
                    });
                    resultHTML += `</tr>`;
                });
                
                resultHTML += `
                                </tbody>
                            </table>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Showing ${data.sample_data.length} of ${data.rows_count} records</p>
                    </div>`;
            } else {
                resultHTML += `
                    <div class="bg-gray-200 p-4 rounded">
                        <p class="text-sm text-gray-700">No traces found in the recent logs.</p>
                    </div>`;
            }
            
            resultsContent.innerHTML = resultHTML;
        } else {
            // Error formatting
            resultsContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">Error connecting to Application Insights</p>
                            <p class="text-sm text-red-700 mt-1">${data.error}</p>
                        </div>
                    </div>
                </div>`;
        }
    } catch (error) {
        // Hide loading spinner
        document.getElementById('appInsightsLoading').classList.add('hidden');
        document.getElementById('appInsightsResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('appInsightsResultsContent');
        resultsContent.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-red-800">Error connecting to Application Insights</p>
                        <p class="text-sm text-red-700 mt-1">${error.message}</p>
                    </div>
                </div>
            </div>`;
    } finally {
        // Re-enable button
        const button = document.getElementById('testAppInsightsBtn');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

// Initialize active tab and load API key on page load
document.addEventListener('DOMContentLoaded', function() {
    switchTab('devops');
    
    // Check if we have a Grafana API key from the server
    const apiKey = "{{ grafana_api_key|default('') }}";
    const apiKeyField = document.getElementById('api_key').value;
    
    if (!apiKeyField || apiKeyField.trim() === '') {
        if (apiKey && apiKey.trim() !== '') {
            // Load it into the field
            loadApiKeyFromEnv();
        } else {
            // Show error notification
            setTimeout(() => {
                showNotification("No Grafana API key found in environment variables. Please check your .env file.", "error");
            }, 1000); // Slight delay to make sure UI is fully loaded
        }
    }
});

async function testGrafanaConnection() {
    console.log("Test Grafana connection called");
    const url = document.getElementById('grafana_url').value;
    let apiKey = document.getElementById('api_key').value;
    
    // Ensure we have the API key - if the API key field has a masked value, get the real key from the data attribute
    if (!apiKey || apiKey.trim() === '' || apiKey.includes('•')) {
        // Use the server-provided API key stored in a data attribute
        apiKey = "{{ grafana_api_key }}";
        console.log("Using API key from environment variables");
    }
    
    console.log("URL:", url);
    console.log("API Key length:", apiKey.length);
    
    try {
        // Show loading spinner
        document.getElementById('grafanaResults').classList.remove('hidden');
        document.getElementById('grafanaLoading').classList.remove('hidden');
        document.getElementById('grafanaResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.getElementById('testGrafanaBtn');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        // Create a much simpler payload with no special characters
        const payload = {
            url: url,
            api_key: apiKey
        };
        
        console.log("Sending payload:", JSON.stringify(payload));
        
        // Use a simpler fetch with minimal options - UPDATE TO CORRECT ENDPOINT PATH
        const response = await fetch('/settings/api/grafana/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        console.log("Response status:", response.status);
        
        // Hide loading spinner
        document.getElementById('grafanaLoading').classList.add('hidden');
        document.getElementById('grafanaResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('grafanaResultsContent');
        
        // Get response as text first
        const responseText = await response.text();
        console.log("Response text:", responseText);
        
        let data;
        try {
            // Try to parse as JSON
            data = JSON.parse(responseText);
            console.log("Parsed JSON:", data);
        } catch (e) {
            console.error("JSON parse error:", e);
            resultsContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">Invalid response from server</p>
                            <p class="text-sm text-red-700 mt-1">Response was not valid JSON</p>
                            <p class="text-xs text-red-600 mt-1">Error: ${e.message}</p>
                        </div>
                    </div>
                </div>`;
            
            // Re-enable button
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
            
            return;
        }
        
        if (data.success) {
            resultsContent.innerHTML = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-800">Connection successful!</p>
                        </div>
                    </div>
                </div>`;
        } else {
            resultsContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">Error connecting to Grafana</p>
                            <p class="text-sm text-red-700 mt-1">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>`;
        }
    } catch (error) {
        console.error("JavaScript error:", error);
        // Hide loading spinner
        document.getElementById('grafanaLoading').classList.add('hidden');
        document.getElementById('grafanaResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('grafanaResultsContent');
        resultsContent.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                <div class="flex">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-red-800">JavaScript Error</p>
                        <p class="text-sm text-red-700 mt-1">${error.message}</p>
                    </div>
                </div>
            </div>`;
    } finally {
        // Re-enable button
        const button = document.getElementById('testGrafanaBtn');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

async function testGrafanaQuery() {
    const url = document.getElementById('grafana_url').value;
    let apiKey = document.getElementById('api_key').value;
    const query = document.getElementById('test_query').value;
    
    // Ensure we have the API key - if the API key field has a masked value, get the real key from the data attribute
    if (!apiKey || apiKey.trim() === '' || apiKey.includes('•')) {
        // Use the server-provided API key stored in a data attribute
        apiKey = "{{ grafana_api_key }}";
        console.log("Using API key from environment variables");
    }
    
    if (!query) {
        showNotification('Please enter a query', 'warning');
        return;
    }
    
    try {
        // Show loading spinner
        document.getElementById('grafanaResults').classList.remove('hidden');
        document.getElementById('grafanaLoading').classList.remove('hidden');
        document.getElementById('grafanaResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.getElementById('testGrafanaQueryBtn');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        const response = await fetch('/settings/api/grafana/test-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                api_key: apiKey,
                query: query
            })
        });

        const data = await response.json();
        
        // Hide loading spinner
        document.getElementById('grafanaLoading').classList.add('hidden');
        document.getElementById('grafanaResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('grafanaResultsContent');
        
        if (data.success) {
            // Format query results
            let resultHTML = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-800">Query executed successfully!</p>
                        </div>
                    </div>
                </div>`;
                
                // Add query info
                resultHTML += `
                    <div class="mb-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Query</h5>
                        <div class="bg-gray-200 p-2 rounded">
                            <code class="text-xs font-mono">${query}</code>
                        </div>
                    </div>`;
                
                // Format results
                resultHTML += `
                    <div class="mb-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Results</h5>
                        <div class="bg-gray-200 p-4 rounded overflow-auto max-h-96">
                            <pre class="text-xs text-gray-800 font-mono">${JSON.stringify(data.results, null, 2)}</pre>
                        </div>
                    </div>`;
                
                resultsContent.innerHTML = resultHTML;
        } else {
            // Error formatting
            resultsContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">Error executing query</p>
                            <p class="text-sm text-red-700 mt-1">${data.error}</p>
                        </div>
                    </div>
                </div>`;
        }
    } catch (error) {
        // Hide loading spinner
        document.getElementById('grafanaLoading').classList.add('hidden');
        document.getElementById('grafanaResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('grafanaResultsContent');
        resultsContent.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-red-800">Error executing query</p>
                        <p class="text-sm text-red-700 mt-1">${error.message}</p>
                    </div>
                </div>
            </div>`;
    } finally {
        // Re-enable button
        const button = document.getElementById('testGrafanaQueryBtn');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

async function testOpenAIConnection() {
    const endpoint = document.getElementById('openai_endpoint').value;
    const apiKey = document.getElementById('openai_api_key').value;
    const deploymentSelect = document.getElementById('openai_deployment');
    
    // Get deployment name based on selection
    let deployment;
    if (deploymentSelect.value === 'custom') {
        deployment = document.getElementById('custom_deployment').value;
    } else {
        deployment = deploymentSelect.value;
    }
    
    if (!endpoint) {
        showNotification('Please enter an endpoint URL', 'warning');
        return;
    }

    try {
        // Show loading spinner
        document.getElementById('openaiResults').classList.remove('hidden');
        document.getElementById('openaiLoading').classList.remove('hidden');
        document.getElementById('openaiResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.querySelector('button[onclick="testOpenAIConnection()"]');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        const response = await fetch('/settings/api/settings/openai/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                endpoint: endpoint,
                api_key: apiKey,
                deployment: deployment
            })
        });

        const data = await response.json();
        
        // Hide loading spinner
        document.getElementById('openaiLoading').classList.add('hidden');
        document.getElementById('openaiResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('openaiResultsContent');
        
        if (data.success) {
            resultsContent.textContent = 'Connection successful! OpenAI is properly configured.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
        
        // Re-enable button
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    } catch (error) {
        // Hide loading spinner
        document.getElementById('openaiLoading').classList.add('hidden');
        document.getElementById('openaiResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('openaiResultsContent');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
        
        // Re-enable button
        const button = document.querySelector('button[onclick="testOpenAIConnection()"]');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

// Add event listener to show/hide custom deployment input field
document.addEventListener('DOMContentLoaded', function() {
    const deploymentSelect = document.getElementById('openai_deployment');
    const customDeploymentContainer = document.getElementById('custom_deployment_container');
    
    deploymentSelect.addEventListener('change', function() {
        if (deploymentSelect.value === 'custom') {
            customDeploymentContainer.classList.remove('hidden');
        } else {
            customDeploymentContainer.classList.add('hidden');
        }
    });
});

async function runKustoQuery() {
    const query = document.getElementById('kusto_query').value;
    const timeRange = document.getElementById('time_range').value;
    
    if (!query) {
        showNotification('Please enter a Kusto query', 'warning');
        return;
    }

    try {
        // Show loading spinner
        document.getElementById('kustoResults').classList.remove('hidden');
        document.getElementById('kustoLoading').classList.remove('hidden');
        document.getElementById('kustoResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.getElementById('runKustoQueryBtn');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        const response = await fetch('/settings/api/appinsights/run-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                timeRange: timeRange
            })
        });

        const data = await response.json();
        
        // Hide loading spinner
        document.getElementById('kustoLoading').classList.add('hidden');
        document.getElementById('kustoResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('kustoResultsContent');
        
        if (data.success) {
            // Format Azure Portal style result
            let resultHTML = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-800">Query executed successfully!</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Query</h5>
                    <div class="bg-gray-200 p-2 rounded">
                        <code class="text-xs font-mono">${query}</code>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Results Summary</h5>
                    <div class="flex items-center text-sm">
                        <svg class="mr-2 h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span class="font-medium">${data.rows_count}</span> records found
                    </div>
                </div>`;
                
            if (data.tables && data.tables.length > 0 && data.tables[0].rows && data.tables[0].rows.length > 0) {
                resultHTML += `
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Results</h5>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 border border-gray-300 rounded">
                                <thead class="bg-gray-200">
                                    <tr>`;
                
                // Create table headers from columns
                data.tables[0].columns.forEach(column => {
                    resultHTML += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">${column.name}</th>`;
                });
                
                resultHTML += `
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-300">`;
                
                // Create table rows
                data.tables[0].rows.forEach(row => {
                    resultHTML += `<tr class="hover:bg-gray-50">`;
                    row.forEach((cell, index) => {
                        const columnName = data.tables[0].columns[index].name.toLowerCase();
                        
                        // Format timestamp if the value looks like a timestamp
                        let cellValue = cell;
                        if (columnName.includes('time') && typeof cellValue === 'string' && cellValue.includes('T')) {
                            try {
                                const date = new Date(cellValue);
                                cellValue = date.toLocaleString();
                            } catch (e) {
                                // Keep original if parsing fails
                            }
                        }
                        
                        // Truncate long cell values with tooltip
                        if (typeof cellValue === 'string' && cellValue.length > 80) {
                            resultHTML += `<td class="px-3 py-2 text-xs" title="${cellValue}">${cellValue.substring(0, 80)}...</td>`;
                        } else {
                            resultHTML += `<td class="px-3 py-2 text-xs">${cellValue !== null ? cellValue : ''}</td>`;
                        }
                    });
                    resultHTML += `</tr>`;
                });
                
                resultHTML += `
                                </tbody>
                            </table>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Showing ${data.tables[0].rows.length} of ${data.rows_count} records</p>
                    </div>`;
            } else {
                resultHTML += `
                    <div class="bg-gray-200 p-4 rounded">
                        <p class="text-sm text-gray-700">No data returned from this query.</p>
                    </div>`;
            }
            
            resultsContent.innerHTML = resultHTML;
        } else {
            // Error formatting
            resultsContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-red-800">Error executing query</p>
                            <p class="text-sm text-red-700 mt-1">${data.error}</p>
                        </div>
                    </div>
                </div>`;
        }
    } catch (error) {
        // Hide loading spinner
        document.getElementById('kustoLoading').classList.add('hidden');
        document.getElementById('kustoResultContainer').classList.remove('hidden');
        
        const resultsContent = document.getElementById('kustoResultsContent');
        resultsContent.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-red-800">Error executing query</p>
                        <p class="text-sm text-red-700 mt-1">${error.message}</p>
                    </div>
                </div>
            </div>`;
    } finally {
        // Re-enable button
        const button = document.getElementById('runKustoQueryBtn');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

function selectGrafanaUrl(url) {
    if (url) {
        document.getElementById('grafana_url').value = url;
    }
}

function toggleApiKeyVisibility() {
    const apiKeyInput = document.getElementById('api_key');
    const eyeIcon = document.getElementById('eye-icon');
    
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        apiKeyInput.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

function copyApiKey() {
    const apiKeyInput = document.getElementById('api_key');
    const apiKey = apiKeyInput.value;
    
    if (apiKey) {
        const tempInput = document.createElement('input');
        tempInput.value = apiKey;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        
        showNotification('API key copied to clipboard', 'success');
    } else {
        showNotification('No API key to copy', 'warning');
    }
}

function loadApiKeyFromEnv() {
    // Get API key from environment variables through template variable
    const apiKey = "{{ grafana_api_key|default('') }}";
    
    if (apiKey) {
        document.getElementById('api_key').value = apiKey;
        document.getElementById('api_key_container').classList.add('border', 'border-green-500');
        
        // Flash effect to indicate successful loading
        setTimeout(() => {
            document.getElementById('api_key_container').classList.remove('border', 'border-green-500');
        }, 2000);
        
        showNotification("API key loaded successfully from environment variables", "success");
        console.log("API key loaded from environment variables");
    } else {
        showNotification("No API key found in environment variables. Please check your .env file.", "error");
    }
}
</script>
{% endblock %} 