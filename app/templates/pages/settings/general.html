{% extends "layouts/authenticated.html" %}

{% block title %}General Settings - Performance Portal{% endblock %}

{% block page_content %}
<div class="min-h-screen bg-gray-100">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        General Settings
                    </h2>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active" 
                        onclick="switchTab('devops')" 
                        data-tab="devops">
                    <i class="fas fa-code-branch mr-2"></i>
                    DevOps
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('app-insights')" 
                        data-tab="app-insights">
                    <i class="fas fa-chart-line mr-2"></i>
                    App Insights
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('grafana')" 
                        data-tab="grafana">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Grafana API
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('azure-openai')" 
                        data-tab="azure-openai">
                    <i class="fas fa-brain mr-2"></i>
                    Azure OpenAI
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="bg-white shadow rounded-lg mt-6">
            <!-- DevOps Settings -->
            <div id="devops" class="tab-content active">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure DevOps Configuration</h3>
                    <form class="space-y-6" id="devopsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization URL</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-200 text-gray-500 text-sm">
                                    https://dev.azure.com/
                                </span>
                                <input type="text" 
                                       id="devops_org_url"
                                       name="devops_org_url"
                                       class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200" 
                                       placeholder="organization">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Your Azure DevOps organization name</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token (PAT)</label>
                            <input type="password" 
                                   id="devops_pat"
                                   name="devops_pat"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="Enter your PAT">
                            <p class="mt-1 text-sm text-gray-500">PAT with Read access to Work Items</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testDevOpsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- DevOps Connection Results -->
                        <div id="devopsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="devopsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- App Insights Settings -->
            <div id="app-insights" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">App Insights Configuration</h3>
                    <form class="space-y-6" id="appInsightsForm">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Application Insights is configured using environment variables. The current configuration is shown below.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Application ID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" 
                                        id="app_id_display"
                                        class="flex-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:border-gray-300 focus:ring-0 cursor-not-allowed"
                                        value="{{ app_insights_id|default('Not configured') }}" 
                                        disabled>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">Set in .env file as APP_INSIGHTS_APPLICATION_ID</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="password" 
                                        id="api_key_display"
                                        class="flex-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:border-gray-300 focus:ring-0 cursor-not-allowed"
                                        value="{{ app_insights_key_masked|default('••••••••') }}" 
                                        disabled>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">Set in .env file as APP_INSIGHTS_API_KEY</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testAppInsightsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- App Insights Connection Results -->
                        <div id="appInsightsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="appInsightsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Grafana API Settings -->
            <div id="grafana" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Grafana API Configuration</h3>
                    <form class="space-y-8" id="grafanaForm">
                        <!-- Connection Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Connection Settings</h4>
                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Grafana URL</label>
                                    <input type="text" 
                                           name="grafana_url"
                                           id="grafana_url"
                                           class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                           placeholder="https://your-grafana-instance.com">
                                    <p class="mt-1 text-sm text-gray-500">Your Grafana instance URL</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input type="password" 
                                           name="api_key"
                                           id="api_key"
                                           class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200">
                                    <p class="mt-1 text-sm text-gray-500">API key with Viewer permissions</p>
                                </div>
                            </div>
                        </div>

                        <!-- Test Query -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Test Query</h4>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Query</label>
                                    <textarea
                                        name="test_query"
                                        id="test_query"
                                        rows="3"
                                        class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                        placeholder="Enter your Grafana query here"></textarea>
                                    <p class="mt-1 text-sm text-gray-500">Example: rate(http_requests_total[5m])</p>
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button type="button"
                                            onclick="testGrafanaConnection()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-plug mr-2"></i>
                                        Test Connection
                                    </button>
                                    <button type="button"
                                            onclick="testGrafanaQuery()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i class="fas fa-play mr-2"></i>
                                        Run Query
                                    </button>
                                </div>
                            </div>
                            <!-- Query Results -->
                            <div id="queryResults" class="mt-4 hidden">
                                <h4 class="text-md font-medium text-gray-800 mb-2">Query Results</h4>
                                <div class="bg-gray-100 rounded-md p-4">
                                    <pre id="queryResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Azure OpenAI Settings -->
            <div id="azure-openai" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure OpenAI Configuration</h3>
                    <form class="space-y-6" id="openaiForm">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Endpoint</label>
                                <input type="text" 
                                       id="openai_endpoint"
                                       name="openai_endpoint"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="https://your-resource.openai.azure.com/">
                                <p class="mt-1 text-sm text-gray-500">Your Azure OpenAI service endpoint URL</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <input type="password" 
                                       id="openai_api_key"
                                       name="openai_api_key"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="Enter your API key">
                                <p class="mt-1 text-sm text-gray-500">Your Azure OpenAI API key</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deployment Name</label>
                                <input type="text" 
                                       id="openai_deployment"
                                       name="openai_deployment"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="Enter deployment name (e.g., gpt-35-turbo)">
                                <p class="mt-1 text-sm text-gray-500">The name of your model deployment</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testOpenAIConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- OpenAI Connection Results -->
                        <div id="openaiResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="openaiResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Save Button -->
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg">
                <div class="flex justify-end">
                    <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.remove('hidden');
    
    // Add active class to selected button
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    activeButton.classList.add('border-blue-500', 'text-blue-600');
}

async function testDevOpsConnection() {
    const orgName = document.getElementById('devops_org_url').value;
    const pat = document.getElementById('devops_pat').value;
    
    if (!orgName || !pat) {
        alert('Please enter both Organization name and PAT');
        return;
    }

    try {
        const response = await fetch('/api/settings/devops/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                organization: orgName,
                pat: pat
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Azure DevOps organization is accessible.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

async function testAppInsightsConnection() {
    try {
        const response = await fetch('/settings/api/appinsights/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})  // Using environment variables from backend
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('appInsightsResults');
        const resultsContent = document.getElementById('appInsightsResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            let resultText = 'Connection successful! Application Insights is properly configured.\n\n';
            resultText += `Query: ${data.query}\n`;
            resultText += `Results found: ${data.rows_count}\n\n`;
            
            if (data.sample_data && data.sample_data.length > 0) {
                resultText += 'Sample data:\n';
                data.sample_data.forEach((row, index) => {
                    resultText += `Row ${index + 1}: ${JSON.stringify(row)}\n`;
                });
            } else {
                resultText += 'No traces found in the recent logs.';
            }
            
            resultsContent.textContent = resultText;
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('appInsightsResults');
        const resultsContent = document.getElementById('appInsightsResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

// Initialize active tab
document.addEventListener('DOMContentLoaded', function() {
    switchTab('devops');
});

async function testGrafanaConnection() {
    const url = document.getElementById('grafana_url').value;
    const apiKey = document.getElementById('api_key').value;
    
    if (!url || !apiKey) {
        alert('Please enter both Grafana URL and API Key');
        return;
    }

    try {
        const response = await fetch('/api/settings/grafana/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();
        if (data.success) {
            alert('Connection successful!');
        } else {
            alert('Connection failed: ' + data.error);
        }
    } catch (error) {
        alert('Error testing connection: ' + error.message);
    }
}

async function testGrafanaQuery() {
    const url = document.getElementById('grafana_url').value;
    const apiKey = document.getElementById('api_key').value;
    const query = document.getElementById('test_query').value;
    
    if (!url || !apiKey || !query) {
        alert('Please enter Grafana URL, API Key, and Query');
        return;
    }

    try {
        const response = await fetch('/api/settings/grafana/test-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                api_key: apiKey,
                query: query
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('queryResults');
        const resultsContent = document.getElementById('queryResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = JSON.stringify(data.results, null, 2);
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('queryResults');
        const resultsContent = document.getElementById('queryResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error executing query: ' + error.message;
    }
}

async function testOpenAIConnection() {
    const endpoint = document.getElementById('openai_endpoint').value;
    const apiKey = document.getElementById('openai_api_key').value;
    
    if (!endpoint || !apiKey) {
        alert('Please enter both Endpoint and API Key');
        return;
    }

    try {
        const response = await fetch('/api/settings/openai/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                endpoint: endpoint,
                api_key: apiKey
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('openaiResults');
        const resultsContent = document.getElementById('openaiResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Azure OpenAI is properly configured.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('openaiResults');
        const resultsContent = document.getElementById('openaiResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}
</script>
{% endblock %} 