{% extends "layouts/authenticated.html" %}

{% block title %}General Settings - Performance Portal{% endblock %}

{% block page_content %}
<div class="min-h-screen bg-gray-100">
    <!-- Global Notification Functions -->
    <script>
    // Global notification functions
    function showToast(message, type = 'info') {
        // Check if notifications-container exists, create if not
        let container = document.getElementById('notifications-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notifications-container';
            container.className = 'fixed bottom-4 right-4 z-50 space-y-4';
            document.body.appendChild(container);
        }
        
        const id = 'notification-' + Date.now();
        
        // Create notification element
        const notification = document.createElement('div');
        notification.id = id;
        notification.classList.add('rounded-lg', 'p-4', 'flex', 'items-center', 'justify-between', 'shadow-lg', 'transform', 'transition-all', 'duration-300', 'translate-y-0', 'opacity-0');
        
        // Set styles based on type
        let icon = '';
        if (type === 'success') {
            notification.classList.add('bg-green-100', 'border-l-4', 'border-green-500', 'text-green-700');
            icon = '<i class="fas fa-check-circle text-green-500 mr-3"></i>';
        } else if (type === 'error') {
            notification.classList.add('bg-red-100', 'border-l-4', 'border-red-500', 'text-red-700');
            icon = '<i class="fas fa-exclamation-circle text-red-500 mr-3"></i>';
        } else if (type === 'warning') {
            notification.classList.add('bg-yellow-100', 'border-l-4', 'border-yellow-500', 'text-yellow-700');
            icon = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>';
        } else {
            notification.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500', 'text-blue-700');
            icon = '<i class="fas fa-info-circle text-blue-500 mr-3"></i>';
        }
        
        // Create content
        notification.innerHTML = `
            <div class="flex items-center">
                ${icon}
                <span>${message}</span>
            </div>
            <button onclick="dismissNotification('${id}')" class="ml-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Add to container
        container.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.replace('opacity-0', 'opacity-100');
        }, 10);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            dismissNotification(id);
        }, 5000);
    }

    // Dismiss notification function
    function dismissNotification(id) {
        const notification = document.getElementById(id);
        if (notification) {
            notification.classList.replace('opacity-100', 'opacity-0');
            notification.classList.add('translate-y-2');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
    }
    </script>
    
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        General Settings
                    </h2>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active" 
                        onclick="switchTab('devops')" 
                        data-tab="devops">
                    <i class="fas fa-code-branch mr-2"></i>
                    DevOps
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('app-insights')" 
                        data-tab="app-insights">
                    <i class="fas fa-chart-line mr-2"></i>
                    App Insights
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('grafana')" 
                        data-tab="grafana">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Grafana API
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('azure-openai')" 
                        data-tab="azure-openai">
                    <i class="fas fa-brain mr-2"></i>
                    Azure OpenAI
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="bg-white shadow rounded-lg mt-6">
            <!-- DevOps Settings -->
            <div id="devops" class="tab-content active">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure DevOps Configuration</h3>
                    <form class="space-y-6" id="devopsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization URL</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-200 text-gray-500 text-sm">
                                    https://dev.azure.com/
                                </span>
                                <input type="text" 
                                       id="devops_org_url"
                                       name="devops_org_url"
                                       class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200" 
                                       placeholder="organization">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Your Azure DevOps organization name</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token (PAT)</label>
                            <input type="password" 
                                   id="devops_pat"
                                   name="devops_pat"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="Enter your PAT">
                            <p class="mt-1 text-sm text-gray-500">PAT with Read access to Work Items</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testDevOpsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- DevOps Connection Results -->
                        <div id="devopsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="devopsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- App Insights Settings -->
            <div id="app-insights" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">App Insights Configuration</h3>
                    <form class="space-y-6" id="appInsightsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Connection String</label>
                            <input type="password" 
                                   id="app_insights_connection"
                                   name="app_insights_connection"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="InstrumentationKey=xxxxx;IngestionEndpoint=xxxxx">
                            <p class="mt-1 text-sm text-gray-500">Your Application Insights connection string</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testAppInsightsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- App Insights Connection Results -->
                        <div id="appInsightsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="appInsightsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Grafana API Settings -->
            <div id="grafana" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Grafana API Configuration</h3>
                    
                    <!-- Tabs for Grafana settings -->
                    <div class="mb-5 border-b border-gray-200">
                        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                            <li class="mr-2">
                                <a href="#" class="grafana-tab inline-block p-4 border-b-2 border-blue-600 rounded-t-lg active text-blue-600" data-tab="grafana-connection">Connection Settings</a>
                            </li>
                            <li class="mr-2">
                                <a href="#" class="grafana-tab inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="grafana-query">Test Query</a>
                            </li>
                            <li class="mr-2">
                                <a href="#" class="grafana-tab inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="chart-test">Chart Test</a>
                            </li>
                        </ul>
                    </div>
                    
                    <form class="space-y-8" id="grafanaForm">
                        <!-- Connection Settings Tab -->
                        <div id="grafana-connection" class="grafana-tab-content active">
                            <div>
                                <h4 class="text-md font-medium text-gray-800 mb-4">Connection Settings</h4>
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Grafana URL</label>
                                        <input type="text" 
                                               name="grafana_url"
                                               id="grafana_url"
                                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                               placeholder="https://your-grafana-instance.com"
                                               value="{{ grafana_url|default('http://10.0.10.16:3000/') }}">
                                        <p class="mt-1 text-sm text-gray-500">Your Grafana instance URL</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                        <input type="password" 
                                               name="api_key"
                                               id="api_key"
                                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200">
                                        <p class="mt-1 text-sm text-gray-500">API key with Viewer permissions</p>
                                    </div>
                                </div>
                                <div class="flex justify-end mt-6">
                                    <button type="button"
                                            onclick="testGrafanaConnection()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-plug mr-2"></i>
                                        Test Connection
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Query Test Tab -->
                        <div id="grafana-query" class="grafana-tab-content hidden">
                            <div>
                                <h4 class="text-md font-medium text-gray-800 mb-4">Test Query</h4>
                                <div class="grid grid-cols-1 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Dashboard URL or Snapshot URL</label>
                                        <input type="text" 
                                               name="dashboard_url"
                                               id="dashboard_url"
                                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                               placeholder="e.g., http://10.0.10.16:3000/d/eeh0kvxjev0u8c/nft-7c-mass-beta-tests"
                                               value="http://10.0.10.16:3000/dashboard/snapshot/6vtmNGCckcTvTho8kI7PSH4DfkHDxsAk">
                                        <p class="mt-1 text-sm text-gray-500">Enter a Grafana dashboard URL or snapshot URL to explore its panels</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel JSON (optional)</label>
                                        <textarea 
                                            id="panel_json" 
                                            rows="5" 
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-xs"
                                            placeholder="Paste Grafana panel JSON here to extract working queries"></textarea>
                                        <div class="flex justify-end mt-2">
                                            <button 
                                                type="button" 
                                                onclick="parsePanelJson()"
                                                class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 border border-blue-200 rounded hover:bg-blue-50">
                                                <i class="fas fa-code mr-1"></i> Extract Queries
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-2">
                                        <button type="button"
                                                onclick="getSnapshotInfo()"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <i class="fas fa-file-image mr-2"></i>
                                            Load Snapshot
                                        </button>
                                        <button type="button"
                                                onclick="getDashboardInfo()"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-search mr-2"></i>
                                            Load Dashboard
                                        </button>
                                    </div>
                                    
                                    <!-- Dashboard Info Container -->
                                    <div id="dashboard-info-container" class="mt-4 border rounded-md p-4 bg-gray-50">
                                        <p class="text-gray-500 text-center">Enter a Grafana dashboard URL and click "Load Dashboard Info" to view panels</p>
                                    </div>
                                    
                                    <!-- CSV Export Form -->
                                    <div class="mt-6 border rounded-md p-4 bg-blue-50">
                                        <h4 class="text-md font-medium text-blue-700 mb-3">Export Panel Data as CSV</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Dashboard UID</label>
                                                <input type="text" 
                                                    id="csv_dashboard_uid" 
                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                    placeholder="eeh0kvxjev0u8c"
                                                    value="eeh0kvxjev0u8c">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Panel ID</label>
                                                <input type="text" 
                                                    id="csv_panel_id" 
                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                    placeholder="73"
                                                    value="73">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">From Time</label>
                                                <input type="text" 
                                                    id="csv_from_time" 
                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                    placeholder="now-1h"
                                                    value="2025-04-02T03:24:00Z">
                                                <p class="mt-1 text-xs text-gray-500">Enter timestamp or relative time like 'now-1h'</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">To Time</label>
                                                <input type="text" 
                                                    id="csv_to_time" 
                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                    placeholder="now"
                                                    value="2025-04-02T03:26:10Z">
                                                <p class="mt-1 text-xs text-gray-500">Enter timestamp or relative time like 'now'</p>
                                            </div>
                                        </div>
                                        <div class="mt-3 flex justify-end">
                                            <button 
                                                type="button" 
                                                onclick="exportPanelCsv()"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                <i class="fas fa-file-csv mr-2"></i>
                                                Export CSV
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="test_query" class="block text-sm font-medium text-gray-700">Test Query</label>
                                        <textarea
                                            id="test_query"
                                            name="test_query"
                                            rows="3"
                                            class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                            placeholder="For InfluxDB: 
SHOW MEASUREMENTS
SHOW DATABASES
SELECT * FROM cpu LIMIT 10">SELECT * FROM mass_nft.autogen.jmeter WHERE time > now() - 1h LIMIT 100</textarea>
                                        <p class="mt-2 text-sm text-gray-500">
                                            Sample queries for jmeter data:
                                            1. <code>SELECT * FROM mass_nft.autogen.jmeter LIMIT 50</code> (most recent 50 records)
                                            2. <code>SELECT * FROM mass_nft.autogen.jmeter WHERE time > now() - 1h</code> (data from last hour)
                                            3. <code>SELECT mean("value") FROM mass_nft.autogen.jmeter WHERE time > now() - 1d GROUP BY time(30m)</code> (30-min averages)
                                        </p>
                                    </div>
                                    <div class="flex justify-end space-x-4">
                                        <button type="button"
                                                id="testGrafanaQueryBtn"
                                                onclick="testGrafanaQuery()"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                            <i class="fas fa-play mr-2"></i>
                                            Run Query
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- InfluxQL Explorer Tab -->
                        <div id="grafana-explorer" class="grafana-tab-content hidden">
                            <div>
                                <h4 class="text-md font-medium text-gray-800 mb-4">InfluxQL Explorer</h4>
                                
                                <!-- Explorer UI -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <!-- Left Panel: Database Tree -->
                                    <div class="md:col-span-1 border border-gray-300 rounded-md p-4 bg-gray-50">
                                        <h5 class="font-medium text-sm text-gray-700 mb-3">Database Structure</h5>
                                        
                                        <!-- Database selector -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Database</label>
                                            <select id="explorer-database" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                                <option value="mass_nft" selected>mass_nft</option>
                                                <option value="mass_nft_get">mass_nft_get</option>
                                                <option value="mass_nft_put">mass_nft_put</option>
                                                <option value="mass-poc">mass-poc</option>
                                            </select>
                                            <button type="button" onclick="loadDatabases()" class="mt-1 text-xs text-blue-600 hover:text-blue-800 cursor-pointer">
                                                Refresh
                                            </button>
                                        </div>
                                        
                                        <div class="mb-4 pb-3 border-b border-gray-200">
                                            <p class="text-xs text-gray-700">
                                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                                Queries are executed through Grafana's API using your Grafana API key.
                                            </p>
                                        </div>
                                        
                                        <!-- Tree View -->
                                        <div id="database-tree" class="text-sm text-gray-700 overflow-auto max-h-96">
                                            <div class="flex items-center">
                                                <i class="fas fa-circle-notch fa-spin text-blue-500 mr-2"></i>
                                                <span>Loading database structure...</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Panel: Query Builder -->
                                    <div class="md:col-span-2 border border-gray-300 rounded-md p-4">
                                        <!-- Quick Action Buttons -->
                                        <div class="flex flex-wrap gap-2 mb-4">
                                            <button type="button" onclick="buildQuery('SHOW DATABASES')" class="px-3 py-1 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                                SHOW DATABASES
                                            </button>
                                            <button type="button" onclick="buildQuery('SHOW MEASUREMENTS')" class="px-3 py-1 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                                SHOW MEASUREMENTS
                                            </button>
                                            <button type="button" onclick="buildQuery('SHOW SERIES')" class="px-3 py-1 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                                SHOW SERIES
                                            </button>
                                            <button type="button" onclick="buildQuery('SHOW TAG KEYS')" class="px-3 py-1 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                                SHOW TAG KEYS
                                            </button>
                                            <button type="button" onclick="buildQuery('SHOW FIELD KEYS')" class="px-3 py-1 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                                SHOW FIELD KEYS
                                            </button>
                                            <button type="button" onclick="buildQuery('use-selected')" class="px-3 py-1 text-xs rounded-md bg-green-100 text-green-700 hover:bg-green-200 transition-colors">
                                                SELECT FROM MEASUREMENT
                                            </button>
                                        </div>
                                        
                                        <!-- Query Builder Form -->
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Query</label>
                                                <textarea 
                                                    id="explorer-query" 
                                                    rows="4" 
                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm"
                                                    placeholder="Enter InfluxQL query or use the buttons above to generate one"></textarea>
                                            </div>
                                            
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Time Range</label>
                                                    <select id="explorer-time-range" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                                        <option value="30m">Last 30 minutes</option>
                                                        <option value="1h">Last 1 hour</option>
                                                        <option value="3h">Last 3 hours</option>
                                                        <option value="6h">Last 6 hours</option>
                                                        <option value="12h">Last 12 hours</option>
                                                        <option value="24h" selected>Last 24 hours</option>
                                                        <option value="2d">Last 2 days</option>
                                                        <option value="7d">Last 7 days</option>
                                                        <option value="30d">Last 30 days</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Limit</label>
                                                    <select id="explorer-limit" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                                        <option value="10">10 rows</option>
                                                        <option value="25">25 rows</option>
                                                        <option value="50" selected>50 rows</option>
                                                        <option value="100">100 rows</option>
                                                        <option value="500">500 rows</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="self-end">
                                                    <button 
                                                        type="button" 
                                                        id="runExplorerQueryBtn"
                                                        onclick="runExplorerQuery()"
                                                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                        <i class="fas fa-play mr-2"></i>
                                                        Run Query
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Query Results -->
                                <div id="explorer-results" class="mt-6 hidden">
                                    <!-- Loading spinner -->
                                    <div id="explorer-loading" class="flex items-center space-x-2 py-4">
                                        <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-indigo-500"></div>
                                        <span class="text-gray-600">Loading results...</span>
                                    </div>
                                    
                                    <!-- Results container -->
                                    <div id="explorer-result-container" class="hidden">
                                        <h3 class="text-lg font-semibold mt-4 mb-2">Query Results</h3>
                                        <div id="explorer-results-content" class="border rounded p-4 bg-gray-50 font-mono text-sm overflow-auto max-h-96"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Query Results section (shared) -->
                        <div id="grafanaResults" class="mt-6 hidden">
                            <!-- Loading spinner -->
                            <div id="grafanaLoading" class="flex items-center space-x-2 py-4">
                                <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-indigo-500"></div>
                                <span class="text-gray-600">Loading results...</span>
                            </div>
                            
                            <!-- Results container -->
                            <div id="grafanaResultContainer" class="hidden">
                                <h3 class="text-lg font-semibold mt-4 mb-2">Query Results</h3>
                                <div id="grafanaResultsContent" class="border rounded p-4 bg-gray-50 font-mono text-sm overflow-auto max-h-96"></div>
                            </div>
                        </div>
                        
                        <!-- Chart Test Tab -->
                        <div id="chart-test" class="grafana-tab-content hidden">
                            <div>
                                <h4 class="text-md font-medium text-gray-800 mb-4">Chart Testing</h4>
                                
                                <!-- Data Input Options -->
                                <div class="mb-6">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">Data Source</h5>
                                    
                                    <!-- Tab navigation for data input -->
                                    <div class="border-b border-gray-200">
                                        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                                            <li class="mr-2">
                                                <a href="#" class="chart-input-tab inline-block p-3 border-b-2 border-blue-600 rounded-t-lg active text-blue-600" data-tab="csv-upload">Upload CSV</a>
                                            </li>
                                            <li class="mr-2">
                                                <a href="#" class="chart-input-tab inline-block p-3 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="paste-data">Paste Data</a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <!-- CSV Upload Section -->
                                    <div id="csv-upload" class="chart-input-content py-4">
                                        <div class="flex items-center justify-center w-full">
                                            <label for="csv-file-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 border-gray-300">
                                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                                    <i class="fas fa-file-csv text-2xl text-gray-500 mb-2"></i>
                                                    <p class="mb-2 text-sm text-gray-500">
                                                        <span class="font-semibold">Click to upload</span> or drag and drop
                                                    </p>
                                                    <p class="text-xs text-gray-500">CSV files only</p>
                                                </div>
                                                <input id="csv-file-upload" type="file" class="hidden" accept=".csv" />
                                            </label>
                                        </div>
                                        <div id="csv-filename" class="mt-2 text-sm text-gray-500 text-center"></div>
                                    </div>
                                    
                                    <!-- Paste Data Section -->
                                    <div id="paste-data" class="chart-input-content py-4 hidden">
                                        <textarea 
                                            id="chart-data-input" 
                                            placeholder="Paste CSV data or table data here..."
                                            class="w-full h-32 p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        ></textarea>
                                        <p class="mt-1 text-xs text-gray-500">
                                            Format: First column should be time/date, subsequent columns will be plotted as lines.
                                        </p>
                                    </div>
                                    
                                    <!-- Chart Rendering Button -->
                                    <div class="mt-4 flex justify-end">
                                        <button type="button"
                                                onclick="renderChart()"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-chart-line mr-2"></i>
                                            Generate Chart
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Chart Configuration -->
                                <div class="mb-6">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">Chart Configuration</h5>
                                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
                                            <input type="text" 
                                                  id="chart-title" 
                                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                  placeholder="Chart Title">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">X-Axis Label</label>
                                            <input type="text" 
                                                  id="x-axis-label" 
                                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                  placeholder="Time">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Y-Axis Label</label>
                                            <input type="text" 
                                                  id="y-axis-label" 
                                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                                                  placeholder="Value">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Chart Display Area -->
                                <div id="chart-container" class="relative bg-white p-4 border border-gray-200 rounded-lg shadow-sm hidden">
                                    <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 hidden">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mb-2"></i>
                                            <p class="text-sm text-gray-600">Generating chart...</p>
                                        </div>
                                    </div>
                                    <div id="chart-error" class="text-center text-red-500 hidden">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <span id="chart-error-message">Error rendering chart</span>
                                    </div>
                                    <div class="h-80">
                                        <canvas id="flowbiteChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize active tab
    switchTab('devops');
    
    // Add click handlers for Grafana tabs
    document.querySelectorAll('.grafana-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = this.getAttribute('data-tab');
            switchGrafanaTab(tabId);
        });
    });
    
    // Add click handlers for chart input tabs
    document.querySelectorAll('.chart-input-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = this.getAttribute('data-tab');
            switchChartInputTab(tabId);
        });
    });
    
    // Handle CSV file upload
    const fileUpload = document.getElementById('csv-file-upload');
    if (fileUpload) {
        fileUpload.addEventListener('change', handleFileUpload);
    }
});

// Function to switch between main tabs
function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
        selectedTab.classList.add('active');
    }
    
    // Add active class to selected button
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    if (activeButton) {
        activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        activeButton.classList.add('border-blue-500', 'text-blue-600');
    }
}

// Switch between Grafana tabs
function switchGrafanaTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.grafana-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.grafana-tab').forEach(tab => {
        tab.classList.remove('active', 'border-blue-600', 'text-blue-600');
        tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    }
    
    // Add active class to selected tab button
    const activeTab = document.querySelector(`.grafana-tab[data-tab="${tabId}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'border-blue-600', 'text-blue-600');
        activeTab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
    }
}

// Switch between chart input tabs
function switchChartInputTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.chart-input-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.chart-input-tab').forEach(tab => {
        tab.classList.remove('active', 'border-blue-600', 'text-blue-600');
        tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    }
    
    // Add active class to selected tab button
    const activeTab = document.querySelector(`.chart-input-tab[data-tab="${tabId}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'border-blue-600', 'text-blue-600');
        activeTab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
    }
}

// Handle file upload
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Display filename
    const filenameElement = document.getElementById('csv-filename');
    if (filenameElement) {
        filenameElement.textContent = file.name;
    }
    
    // Read file content
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvData = e.target.result;
        // Store CSV data for chart rendering
        window.csvData = csvData;
    };
    reader.readAsText(file);
}

// Render chart from CSV data or pasted data
function renderChart() {
    // Get data source
    let data;
    const csvUploadTab = document.getElementById('csv-upload');
    const pasteDataTab = document.getElementById('paste-data');
    
    if (csvUploadTab && !csvUploadTab.classList.contains('hidden')) {
        // Use uploaded CSV file
        if (!window.csvData) {
            showToast('Please upload a CSV file first', 'error');
            return;
        }
        data = window.csvData;
    } else if (pasteDataTab && !pasteDataTab.classList.contains('hidden')) {
        // Use pasted data
        const textInput = document.getElementById('chart-data-input');
        if (!textInput || !textInput.value.trim()) {
            showToast('Please paste data first', 'error');
            return;
        }
        data = textInput.value;
    } else {
        showToast('Please provide data for the chart', 'error');
        return;
    }
    
    // Show chart container and loading indicator
    const chartContainer = document.getElementById('chart-container');
    const loadingIndicator = document.getElementById('chart-loading');
    const errorMessage = document.getElementById('chart-error');
    
    if (chartContainer) chartContainer.classList.remove('hidden');
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    if (errorMessage) errorMessage.classList.add('hidden');
    
    // Parse CSV data
    try {
        const parsedData = parseCSVData(data);
        
        // Get chart configuration
        const chartTitle = document.getElementById('chart-title').value || 'Chart';
        const xAxisLabel = document.getElementById('x-axis-label').value || 'Time';
        const yAxisLabel = document.getElementById('y-axis-label').value || 'Value';
        
        // Create the chart
        createChart(parsedData, chartTitle, xAxisLabel, yAxisLabel);
        
        // Hide loading indicator
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
    } catch (error) {
        console.error('Error creating chart:', error);
        
        // Show error message
        if (errorMessage) {
            errorMessage.classList.remove('hidden');
            const errorMessageText = document.getElementById('chart-error-message');
            if (errorMessageText) {
                errorMessageText.textContent = error.message || 'Error rendering chart';
            }
        }
        
        // Hide loading indicator
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        
        showToast('Error creating chart: ' + (error.message || 'Unknown error'), 'error');
    }
}

// Parse CSV data into chart-friendly format
function parseCSVData(csvString) {
    // Split into lines and remove any empty lines
    const lines = csvString.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) {
        throw new Error('Not enough data to create a chart');
    }
    
    // Parse header row to get column names
    const headers = parseCSVLine(lines[0]);
    if (headers.length < 2) {
        throw new Error('At least two columns are required (time and value)');
    }
    
    // Parse data rows
    const datasets = [];
    for (let i = 1; i < headers.length; i++) {
        datasets.push({
            label: headers[i],
            data: [],
            borderColor: getRandomColor(),
            tension: 0.3,
            fill: false
        });
    }
    
    // Parse each data row
    const labels = [];
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length < headers.length) continue;
        
        // First column is the x-axis (usually time)
        labels.push(values[0]);
        
        // Remaining columns are data series
        for (let j = 1; j < values.length && j < headers.length; j++) {
            const value = parseFloat(values[j]);
            datasets[j-1].data.push(isNaN(value) ? 0 : value);
        }
    }
    
    return {
        labels: labels,
        datasets: datasets
    };
}

// Parse a single CSV line, handling quotes and commas properly
function parseCSVLine(line) {
    const result = [];
    let currentValue = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"' && !inQuotes) {
            inQuotes = true;
        } else if (char === '"' && inQuotes) {
            // Check for escaped quote
            if (i + 1 < line.length && line[i + 1] === '"') {
                currentValue += '"';
                i++; // Skip the next quote
            } else {
                inQuotes = false;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(currentValue);
            currentValue = '';
        } else {
            currentValue += char;
        }
    }
    
    // Add the last value
    result.push(currentValue);
    
    return result;
}

// Generate a random color for chart lines
function getRandomColor() {
    const colors = [
        '#4F46E5', // indigo-600
        '#0891B2', // cyan-600
        '#059669', // emerald-600
        '#D97706', // amber-600
        '#DC2626', // red-600
        '#7C3AED', // violet-600
        '#2563EB', // blue-600
        '#C026D3', // fuchsia-600
        '#EA580C', // orange-600
        '#4338CA'  // indigo-700
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

// Create and render the chart using Chart.js (compatible with Flowbite)
function createChart(data, title, xAxisLabel, yAxisLabel) {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        // If Chart.js is not loaded, load it dynamically
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
            // Create chart once Chart.js is loaded
            initializeChart(data, title, xAxisLabel, yAxisLabel);
        };
        document.head.appendChild(script);
    } else {
        // Chart.js is already loaded
        initializeChart(data, title, xAxisLabel, yAxisLabel);
    }
}

// Initialize chart once Chart.js is available
function initializeChart(data, title, xAxisLabel, yAxisLabel) {
    const ctx = document.getElementById('flowbiteChart');
    
    // Destroy existing chart if any
    if (window.myLineChart) {
        window.myLineChart.destroy();
    }
    
    // Create new chart
    window.myLineChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 6
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: xAxisLabel
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: yAxisLabel
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

/**
 * Exports panel data as CSV
 */
function exportPanelCsv() {
    const dashboardUid = document.getElementById('csv_dashboard_uid').value.trim();
    const panelId = document.getElementById('csv_panel_id').value.trim();
    const fromTime = document.getElementById('csv_from_time').value.trim();
    const toTime = document.getElementById('csv_to_time').value.trim();
    
    if (!dashboardUid || !panelId) {
        showToast('Dashboard UID and Panel ID are required', 'error');
        return;
    }
    
    if (!fromTime || !toTime) {
        showToast('From and To times are required', 'error');
        return;
    }
    
    // Show loading indicator
    showToast('Exporting CSV data...', 'info');
    
    fetch('/grafana/export-csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            url: document.getElementById('grafana_url').value.trim(),
            api_key: document.getElementById('api_key').value.trim(),
            dashboard_uid: dashboardUid,
            panel_id: panelId,
            from: fromTime,
            to: toTime
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || 'Error exporting CSV'); });
        }
        return response.blob();
    })
    .then(blob => {
        // Create a download link and trigger the download
        const filename = `panel_${panelId}_${new Date().toISOString().slice(0,10)}.csv`;
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showToast('CSV downloaded successfully', 'success');
    })
    .catch(error => {
        console.error('Error exporting CSV:', error);
        showToast(`Error exporting CSV: ${error.message}`, 'error');
    });
}
</script>

<style>
    /* Animation for highlighting the textarea */
    @keyframes highlightPulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    
    .highlight-pulse {
        animation: highlightPulse 1s ease-in-out;
        border-color: #3b82f6 !important;
    }
</style>

<!-- Notifications container -->
<div id="notifications-container" class="fixed bottom-4 right-4 z-50 space-y-4"></div>
{% endblock %} 