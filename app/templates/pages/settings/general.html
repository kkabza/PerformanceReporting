{% extends "layouts/authenticated.html" %}

{% block title %}General Settings - Performance Portal{% endblock %}

{% block page_content %}
<div class="min-h-screen bg-gray-100">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        General Settings
                    </h2>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active" 
                        onclick="switchTab('devops')" 
                        data-tab="devops">
                    <i class="fas fa-code-branch mr-2"></i>
                    DevOps
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('app-insights')" 
                        data-tab="app-insights">
                    <i class="fas fa-chart-line mr-2"></i>
                    App Insights
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('grafana')" 
                        data-tab="grafana">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Grafana API
                </button>
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        onclick="switchTab('azure-openai')" 
                        data-tab="azure-openai">
                    <i class="fas fa-brain mr-2"></i>
                    Azure OpenAI
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="bg-white shadow rounded-lg mt-6">
            <!-- DevOps Settings -->
            <div id="devops" class="tab-content active">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure DevOps Configuration</h3>
                    <form class="space-y-6" id="devopsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization URL</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-200 text-gray-500 text-sm">
                                    https://dev.azure.com/
                                </span>
                                <input type="text" 
                                       id="devops_org_url"
                                       name="devops_org_url"
                                       class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200" 
                                       placeholder="organization">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Your Azure DevOps organization name</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token (PAT)</label>
                            <input type="password" 
                                   id="devops_pat"
                                   name="devops_pat"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="Enter your PAT">
                            <p class="mt-1 text-sm text-gray-500">PAT with Read access to Work Items</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testDevOpsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- DevOps Connection Results -->
                        <div id="devopsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="devopsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- App Insights Settings -->
            <div id="app-insights" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">App Insights Configuration</h3>
                    <form class="space-y-6" id="appInsightsForm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Connection String</label>
                            <input type="password" 
                                   id="app_insights_connection"
                                   name="app_insights_connection"
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                   placeholder="InstrumentationKey=xxxxx;IngestionEndpoint=xxxxx">
                            <p class="mt-1 text-sm text-gray-500">Your Application Insights connection string</p>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testAppInsightsConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- App Insights Connection Results -->
                        <div id="appInsightsResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="appInsightsResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Grafana API Settings -->
            <div id="grafana" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Grafana API Configuration</h3>
                    <form class="space-y-8" id="grafanaForm">
                        <!-- Connection Settings -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Connection Settings</h4>
                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Grafana URL</label>
                                    <input type="text" 
                                           name="grafana_url"
                                           id="grafana_url"
                                           class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                           placeholder="https://your-grafana-instance.com"
                                           value="{{ grafana_url|default('http://10.0.10.16:3000/') }}">
                                    <p class="mt-1 text-sm text-gray-500">Your Grafana instance URL</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input type="password" 
                                           name="api_key"
                                           id="api_key"
                                           class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200">
                                    <p class="mt-1 text-sm text-gray-500">API key with Viewer permissions</p>
                                </div>
                            </div>
                        </div>

                        <!-- Test Query -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-4">Test Query</h4>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label for="test_query" class="block text-sm font-medium text-gray-700">Test Query</label>
                                    <textarea
                                        id="test_query"
                                        name="test_query"
                                        rows="3"
                                        class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                        placeholder="For InfluxDB: 
SHOW MEASUREMENTS
SHOW DATABASES
SELECT * FROM cpu LIMIT 10">SHOW MEASUREMENTS</textarea>
                                    <p class="mt-2 text-sm text-gray-500">
                                        Enter a query to test. For InfluxDB try: <code>SHOW MEASUREMENTS</code> (without FROM) or <code>SHOW DATABASES</code>.
                                    </p>
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button type="button"
                                            onclick="testGrafanaConnection()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-plug mr-2"></i>
                                        Test Connection
                                    </button>
                                    <button type="button"
                                            id="testGrafanaQueryBtn"
                                            onclick="testGrafanaQuery()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i class="fas fa-play mr-2"></i>
                                        Run Query
                                    </button>
                                </div>
                            </div>
                            <!-- Query Results -->
                            <div id="grafanaResults" class="mt-6 hidden">
                                <!-- Loading spinner -->
                                <div id="grafanaLoading" class="flex items-center space-x-2 py-4">
                                    <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-indigo-500"></div>
                                    <span class="text-gray-600">Loading results...</span>
                                </div>
                                
                                <!-- Results container -->
                                <div id="grafanaResultContainer" class="hidden">
                                    <h3 class="text-lg font-semibold mt-4 mb-2">Query Results</h3>
                                    <div id="grafanaResultsContent" class="border rounded p-4 bg-gray-50 font-mono text-sm overflow-auto max-h-96"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Azure OpenAI Settings -->
            <div id="azure-openai" class="tab-content hidden">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">Azure OpenAI Configuration</h3>
                    <form class="space-y-6" id="openaiForm">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Endpoint</label>
                                <input type="text" 
                                       id="openai_endpoint"
                                       name="openai_endpoint"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="https://your-resource.openai.azure.com/">
                                <p class="mt-1 text-sm text-gray-500">Your Azure OpenAI service endpoint URL</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <input type="password" 
                                       id="openai_api_key"
                                       name="openai_api_key"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="Enter your API key">
                                <p class="mt-1 text-sm text-gray-500">Your Azure OpenAI API key</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deployment Name</label>
                                <input type="text" 
                                       id="openai_deployment"
                                       name="openai_deployment"
                                       class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-white hover:border-gray-500 transition-all duration-200"
                                       placeholder="Enter deployment name (e.g., gpt-35-turbo)">
                                <p class="mt-1 text-sm text-gray-500">The name of your model deployment</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="testOpenAIConnection()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plug mr-2"></i>
                                Test Connection
                            </button>
                        </div>
                        <!-- OpenAI Connection Results -->
                        <div id="openaiResults" class="mt-4 hidden">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Connection Results</h4>
                            <div class="bg-gray-100 rounded-md p-4">
                                <pre id="openaiResultsContent" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Save Button -->
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg">
                <div class="flex justify-end">
                    <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Notifications container -->
<div id="notifications-container" class="fixed bottom-4 right-4 z-50 space-y-4"></div>

<script>
function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.remove('hidden');
    
    // Add active class to selected button
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    activeButton.classList.add('border-blue-500', 'text-blue-600');
}

async function testDevOpsConnection() {
    const orgName = document.getElementById('devops_org_url').value;
    const pat = document.getElementById('devops_pat').value;
    
    if (!orgName || !pat) {
        alert('Please enter both Organization name and PAT');
        return;
    }

    try {
        const response = await fetch('/api/settings/devops/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                organization: orgName,
                pat: pat
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Azure DevOps organization is accessible.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('devopsResults');
        const resultsContent = document.getElementById('devopsResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

async function testAppInsightsConnection() {
    const connectionString = document.getElementById('app_insights_connection').value;
    
    if (!connectionString) {
        alert('Please enter Application Insights connection string');
        return;
    }

    try {
        const response = await fetch('/api/settings/appinsights/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                connection_string: connectionString
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('appInsightsResults');
        const resultsContent = document.getElementById('appInsightsResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Application Insights is properly configured.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('appInsightsResults');
        const resultsContent = document.getElementById('appInsightsResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

// Initialize active tab
document.addEventListener('DOMContentLoaded', function() {
    switchTab('devops');
});

async function testGrafanaConnection() {
    console.log("Test Grafana connection called");
    const url = document.getElementById('grafana_url').value;
    let apiKey = document.getElementById('api_key').value;
    
    // If empty, try to use environment variable
    if (!apiKey || apiKey.trim() === '') {
        apiKey = "{{ grafana_api_key|default('') }}";
        console.log("Using API key from environment variables");
    }
    
    if (!url) {
        showNotification('Please enter Grafana URL', 'warning');
        return;
    }
    
    if (!apiKey) {
        showNotification('Please enter API Key', 'warning');
        return;
    }
    
    console.log("URL:", url);
    console.log("API Key length:", apiKey.length);
    
    try {
        // Show loading state
        const saveButton = document.querySelector('button[type="submit"]');
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Testing...';
        
        const response = await fetch('/settings/grafana/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();
        
        // Reset button state
        saveButton.disabled = false;
        saveButton.innerHTML = 'Save Changes';
        
        if (data.success) {
            showNotification(`Connection successful! Grafana version: ${data.version || 'unknown'}`, 'success');
        } else {
            let errorMessage = `Connection failed: ${data.error}`;
            
            // Create error details element if there's a preview
            if (data.response_preview) {
                // Add error details to the page
                const resultsDiv = document.getElementById('queryResults');
                const resultsContent = document.getElementById('queryResultsContent');
                
                resultsDiv.classList.remove('hidden');
                resultsContent.textContent = `Error details:\n${data.response_preview}`;
                
                errorMessage += '\nSee details below for more information.';
            }
            
            showNotification(errorMessage, 'error');
        }
    } catch (error) {
        // Reset button state
        const saveButton = document.querySelector('button[type="submit"]');
        saveButton.disabled = false;
        saveButton.innerHTML = 'Save Changes';
        
        showNotification(`Error testing connection: ${error.message}`, 'error');
    }
}

async function testGrafanaQuery() {
    const url = document.getElementById('grafana_url').value;
    let apiKey = document.getElementById('api_key').value;
    const query = document.getElementById('test_query').value;
    
    // If empty, try to use environment variable
    if (!apiKey || apiKey.trim() === '') {
        apiKey = "{{ grafana_api_key|default('') }}";
        console.log("Using API key from environment variables");
    }
    
    if (!query) {
        showNotification('Please enter a query', 'warning');
        return;
    }
    
    try {
        // Show loading spinner
        document.getElementById('grafanaResults').classList.remove('hidden');
        document.getElementById('grafanaLoading').classList.remove('hidden');
        document.getElementById('grafanaResultContainer').classList.add('hidden');
        
        // Disable button during request
        const button = document.getElementById('testGrafanaQueryBtn');
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        const response = await fetch('/settings/grafana/test-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                api_key: apiKey,
                query: query
            })
        });
        
        // Check content type of response
        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
            // Parse as JSON if content type is JSON
            data = await response.json();
        } else {
            // Handle non-JSON response (HTML, text, etc.)
            const responseText = await response.text();
            data = {
                success: false,
                error: 'Server returned non-JSON response',
                html_response: responseText,
                status: response.status
            };
        }
        
        // Hide loading spinner
        document.getElementById('grafanaLoading').classList.add('hidden');
        
        // Enable button
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
        
        if (data.success) {
            // Format the results
            let formattedResults = '';
            
            // Check if the response has the expected structure
            if (data.results && data.results.results) {
                // Extract the frames data
                const frames = data.results.results.A.frames;
                if (frames && frames.length > 0) {
                    // Generate a formatted table
                    formattedResults = formatGrafanaResults(frames);
                } else {
                    formattedResults = 'Query executed successfully, but no data was returned.';
                }
            } else {
                formattedResults = 'Query executed successfully, but returned an unexpected format.';
            }
            
            // Update the results container
            document.getElementById('grafanaResultContainer').classList.remove('hidden');
            document.getElementById('grafanaResultsContent').innerHTML = formattedResults;
            
            showNotification('Query executed successfully', 'success');
        } else {
            // Check if there's an HTML response
            if (data.html_response) {
                // Display the HTML response in the results container
                document.getElementById('grafanaResultContainer').classList.remove('hidden');
                document.getElementById('grafanaResultsContent').innerHTML = 
                    '<div class="bg-red-50 p-4 rounded border border-red-200 text-sm text-red-700 font-mono overflow-auto max-h-96">' +
                    '<h3 class="font-bold mb-2">HTML Response (Status ' + data.status + '): This likely means:</h3>' +
                    '<ul class="list-disc ml-5 mb-3">' +
                    '<li>Redirect to a login page</li>' + 
                    '<li>Invalid URL or API endpoint</li>' +
                    '<li>Server error returned as HTML</li>' +
                    '</ul>' +
                    '<pre class="text-xs">' + escapeHtml(data.html_response.substring(0, 1000)) + '...</pre>' +
                    '</div>';
            } else {
                // Format error with details about the query that was sent
                let errorHtml = '<div class="bg-red-50 p-4 rounded border border-red-200 text-sm text-red-700">';
                
                // Add error message
                errorHtml += '<h3 class="font-bold mb-2">Error:</h3>';
                errorHtml += '<p class="mb-3">' + escapeHtml(data.error) + '</p>';
                
                // Add query information
                if (data.query_sent) {
                    errorHtml += '<h3 class="font-bold mb-2 mt-4">Query Sent:</h3>';
                    errorHtml += '<pre class="bg-gray-800 text-white p-2 rounded mb-3 overflow-auto">' + escapeHtml(data.query_sent) + '</pre>';
                }
                
                // Add suggestions if available
                if (data.suggestion) {
                    errorHtml += '<h3 class="font-bold mb-2 mt-4">Suggestion:</h3>';
                    errorHtml += '<div class="bg-blue-50 p-3 rounded border border-blue-200 text-blue-700">' + 
                                  '<i class="fas fa-lightbulb text-yellow-500 mr-2"></i> ' + 
                                  escapeHtml(data.suggestion) + 
                                 '</div>';
                }
                
                // Add details if available
                if (data.details) {
                    errorHtml += '<h3 class="font-bold mb-2 mt-4">Error Details:</h3>';
                    errorHtml += '<pre class="bg-gray-100 p-2 rounded text-xs overflow-auto">' + escapeHtml(data.details) + '</pre>';
                }
                
                errorHtml += '</div>';
                
                // Show the error details in the result container
                document.getElementById('grafanaResultContainer').classList.remove('hidden');
                document.getElementById('grafanaResultsContent').innerHTML = errorHtml;
            }
            
            showNotification('Error executing query: ' + data.error, 'error');
        }
        
    } catch (error) {
        // Hide loading spinner and show error
        document.getElementById('grafanaLoading').classList.add('hidden');
        document.getElementById('grafanaResultContainer').classList.remove('hidden');
        document.getElementById('grafanaResultsContent').innerText = 'Error parsing response: ' + error.message;
        
        // Enable button
        const button = document.getElementById('testGrafanaQueryBtn');
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
        
        showNotification('Error: ' + error.message, 'error');
    }
}

// Helper function to safely escape HTML content
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Helper function to format Grafana results as a table
function formatGrafanaResults(frames) {
    let html = '<div class="overflow-x-auto">';
    
    for (const frame of frames) {
        html += '<div class="mb-6">';
        
        // Add frame name if available
        if (frame.name) {
            html += `<h3 class="text-lg font-semibold mb-2">${frame.name}</h3>`;
        }
        
        // Create table
        html += '<table class="min-w-full bg-white border border-gray-300">';
        
        // Create table header
        html += '<thead><tr class="bg-gray-100">';
        if (frame.schema && frame.schema.fields) {
            for (const field of frame.schema.fields) {
                html += `<th class="border border-gray-300 px-4 py-2">${field.name}</th>`;
            }
        }
        html += '</tr></thead>';
        
        // Create table body
        html += '<tbody>';
        if (frame.data && frame.data.values && frame.data.values.length > 0) {
            // Calculate number of rows
            const numRows = frame.data.values[0].length || 0;
            
            // Create rows
            for (let i = 0; i < numRows; i++) {
                html += '<tr>';
                for (let j = 0; j < frame.data.values.length; j++) {
                    const value = frame.data.values[j][i];
                    html += `<td class="border border-gray-300 px-4 py-2">${value}</td>`;
                }
                html += '</tr>';
            }
        } else {
            html += '<tr><td colspan="100%" class="px-4 py-2 text-center text-gray-500">No data available</td></tr>';
        }
        html += '</tbody></table></div>';
    }
    
    html += '</div>';
    return html;
}

async function testOpenAIConnection() {
    const endpoint = document.getElementById('openai_endpoint').value;
    const apiKey = document.getElementById('openai_api_key').value;
    
    if (!endpoint || !apiKey) {
        alert('Please enter both Endpoint and API Key');
        return;
    }

    try {
        const response = await fetch('/api/settings/openai/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                endpoint: endpoint,
                api_key: apiKey
            })
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('openaiResults');
        const resultsContent = document.getElementById('openaiResultsContent');
        
        resultsDiv.classList.remove('hidden');
        if (data.success) {
            resultsContent.textContent = 'Connection successful! Azure OpenAI is properly configured.';
        } else {
            resultsContent.textContent = 'Error: ' + data.error;
        }
    } catch (error) {
        const resultsDiv = document.getElementById('openaiResults');
        const resultsContent = document.getElementById('openaiResultsContent');
        resultsDiv.classList.remove('hidden');
        resultsContent.textContent = 'Error testing connection: ' + error.message;
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    const container = document.getElementById('notifications-container');
    const id = 'notification-' + Date.now();
    
    // Create notification element
    const notification = document.createElement('div');
    notification.id = id;
    notification.classList.add('rounded-lg', 'p-4', 'flex', 'items-center', 'justify-between', 'shadow-lg', 'transform', 'transition-all', 'duration-300', 'translate-y-0', 'opacity-0');
    
    // Set styles based on type
    let icon = '';
    if (type === 'success') {
        notification.classList.add('bg-green-100', 'border-l-4', 'border-green-500', 'text-green-700');
        icon = '<i class="fas fa-check-circle text-green-500 mr-3"></i>';
    } else if (type === 'error') {
        notification.classList.add('bg-red-100', 'border-l-4', 'border-red-500', 'text-red-700');
        icon = '<i class="fas fa-exclamation-circle text-red-500 mr-3"></i>';
    } else if (type === 'warning') {
        notification.classList.add('bg-yellow-100', 'border-l-4', 'border-yellow-500', 'text-yellow-700');
        icon = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>';
    } else {
        notification.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500', 'text-blue-700');
        icon = '<i class="fas fa-info-circle text-blue-500 mr-3"></i>';
    }
    
    // Create content
    notification.innerHTML = `
        <div class="flex items-center">
            ${icon}
            <span>${message}</span>
        </div>
        <button onclick="dismissNotification('${id}')" class="ml-4 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Add to container
    container.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.replace('opacity-0', 'opacity-100');
    }, 10);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        dismissNotification(id);
    }, 5000);
}

// Dismiss notification function
function dismissNotification(id) {
    const notification = document.getElementById(id);
    if (notification) {
        notification.classList.replace('opacity-100', 'opacity-0');
        notification.classList.add('translate-y-2');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
}
</script>
{% endblock %} 